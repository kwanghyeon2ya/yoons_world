<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iyoons.world.dao.CommentsDAO">

	<select id="getCommentsList" resultType="com.iyoons.world.vo.CommentsVO">
		select cd.* from
		(select
			c.comm_seq,
			c.comm_content,
			c.comm_group,
			c.comm_step,
			c.comm_level,
			c.post_seq,
			c.regr_seq,
			c.first_insert_dt,
			c.updr_seq,
			c.last_update_dt,
			c.status,
			rownum r 
		from
			(select * from comments order by comm_group desc,comm_level,comm_step desc)c
		where 
			post_seq = #{postSeq} and status = 0)cd 
		where	
			cd.r &gt;= #{startRow} and cd.r &lt;= #{endRow}
	</select>
	
	<insert id="insertComments">
			insert into comments(comm_seq,
								 comm_content,
								 comm_group,
								 comm_level,
								 comm_step,
								 post_seq,
								 regr_seq,
								 first_insert_dt,
								 updr_seq,
								 last_update_dt,
								 status
								 	)
				 		  values(#{commSeq},
				 		  		 #{commContent},
	   <if test="commGroup != 1">#{commGroup},</if>
	   <if test="commGroup == 1">#{commSeq},</if>
	   <if test="commGroup != 1">#{commLevel},</if>
	   <if test="commGroup == 1">0,</if>
	   <if test="commGroup != 1">#{commStep},</if>
	   <if test="commGroup == 1">0,</if>
				 		  		 #{postSeq},
				 		  		 #{regrSeq},
				 		  		 sysdate,
				 		  		 0,
				 		  		 sysdate,
				 		  		 0
				 					)
		<selectKey resultType="int" keyProperty="commSeq" order="BEFORE">
			select comm_seq.nextval from dual	
		</selectKey>
		</insert>
	<select id="getCommentsCount" resultType="int">
		select count(comm_seq) from comments where post_seq = #{postSeq} and status = 0
	</select>
	<select id="getComment" resultType="com.iyoons.world.vo.CommentsVO">
		select
			max(comm_step) maxCommStep,
			comm_level,
			comm_group
		from
			comments
		where
			comm_seq = #{commSeq} 
			and post_seq = #{postSeq}
		group by
			comm_level,
			comm_group
	</select>
	<update id="incrementOriginalCommStep">
		update
			comments
		set 
			comm_step = comm_step + 1 
		where
			comm_group = #{commGroup} 
			and comm_step &gt; #{commStep} 
	</update>
</mapper>