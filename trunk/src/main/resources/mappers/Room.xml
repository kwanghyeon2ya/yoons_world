<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iyoons.world.dao.RoomDAO">

	<insert id="makeReservation" parameterType="com.iyoons.world.vo.RoomVO">
		insert into room_reservation(reserve_seq,
									 room_subject,
									 room_content,
									 room_status,
									 start_dt,
									 end_dt,
									 reg_dt,
									 rgtr_id
									)
								values(
									reserve_seq.nextval,
									#{roomSubject},
									#{roomContent},
									1,
									TO_DATE(#{startDt},'YYYY-MM-DD HH24:MI:SS'),
									TO_DATE(#{endDt},'YYYY-MM-DD HH24:MI:SS'),
									SYSDATE,
									#{rgtrId}
									)
	</insert>


	<select id="checkIsAvailableStartUPD" parameterType="com.iyoons.world.vo.RoomVO" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			ROOM_RESERVATION
		where 
			TO_DATE(#{startDt},'YYYY-MM-DD HH24:MI:SS') BETWEEN START_DT AND END_DT
			AND ROOM_STATUS = 1
			AND RESERVE_SEQ != #{reserveSeq}
	</select>
	
	<select id="checkIsAvailableEndUPD" parameterType="com.iyoons.world.vo.RoomVO" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			ROOM_RESERVATION
		where 
			TO_DATE(#{endDt},'YYYY-MM-DD HH24:MI:SS') BETWEEN START_DT AND END_DT
			AND ROOM_STATUS = 1
			AND RESERVE_SEQ != #{reserveSeq}
	</select>
	
	<select id="checkIsAvailableStartDT" parameterType="String" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			ROOM_RESERVATION
		where 
			TO_DATE(#{startDt},'YYYY-MM-DD HH24:MI:SS') BETWEEN START_DT AND END_DT
			AND ROOM_STATUS = 1
	</select>
	
	<select id="checkIsAvailableEndDT" parameterType="String" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			ROOM_RESERVATION
		where 
			TO_DATE(#{endDt},'YYYY-MM-DD HH24:MI:SS') BETWEEN START_DT AND END_DT
			AND ROOM_STATUS = 1
	</select>
	
	<select id="getReservation" resultType="com.iyoons.world.vo.RoomVO">
		SELECT 
			RESERVE_SEQ AS "ID",
			ROOM_SUBJECT AS "TITLE",
			TO_CHAR(START_DT,'YYYY-MM-DD HH24:MI:SS') AS "START",
			TO_CHAR(END_DT,'YYYY-MM-DD HH24:MI:SS') AS "END",
			room_content
		FROM
			ROOM_RESERVATION
		WHERE 
			ROOM_STATUS = 1
			AND DEL_YN != 'Y'
	</select>
	
	<select id="readReservation" resultType="com.iyoons.world.vo.RoomVO">
		SELECT 
			ROOM_CONTENT,
			ROOM_SUBJECT,
			TO_CHAR(START_DT,'YYYY-MM-DD HH24:MI:SS') AS START_DT,
			TO_CHAR(END_DT,'YYYY-MM-DD HH24:MI:SS') AS END_DT ,
			TO_CHAR(REG_DT,'YYYY-MM-DD HH24:MI:SS') AS REG_DT,
			(SELECT USER_NAME FROM ROOM_RESERVATION RR INNER JOIN USER_INFO UI ON to_number(REPLACE(NVL(RR.RGTR_ID,'0'),'SYSTEM',1)) = UI.USER_SEQ WHERE RR.RESERVE_SEQ = #{reserveSeq}) AS "RGTR_NAME",
			TO_CHAR(MDFCN_DT,'YYYY-MM-DD HH24:MI:SS') AS MDFCN_DT,
			(SELECT USER_NAME FROM ROOM_RESERVATION RR INNER JOIN USER_INFO UI ON to_number(REPLACE(NVL(RR.MDFR_ID,'0'),'SYSTEM',1)) = UI.USER_SEQ WHERE RR.RESERVE_SEQ = #{reserveSeq}) AS "MDFR_NAME"
		FROM
			ROOM_RESERVATION
		WHERE
			ROOM_STATUS = 1
			AND RESERVE_SEQ = #{reserveSeq}
			AND DEL_YN != 'Y'
	</select>
	
	<select id="getDepName" resultType="com.iyoons.world.vo.RoomVO">
		SELECT DISTINCT
			(SELECT D.DEP_NAME FROM DEP D INNER JOIN DEP_USER DU ON DU.DEP_SEQ = D.DEP_SEQ WHERE DU.USER_SEQ = #{userSeq}) AS "MDFR_DEP_NAME",
			(SELECT D.DEP_NAME FROM DEP D INNER JOIN DEP_USER DU ON D.DEP_SEQ = DU.DEP_SEQ
			INNER JOIN ROOM_RESERVATION RR ON RR.RGTR_ID = DU.USER_SEQ 
			WHERE RR.RESERVE_SEQ = #{reserveSeq}) as "rgtr_dep_name"
		FROM
			ROOM_RESERVATION
		WHERE
			ROOM_STATUS = 1
	</select>
	
	<update id="updateReservation">
		UPDATE
			ROOM_RESERVATION
		SET
			ROOM_SUBJECT = #{roomSubject},
			ROOM_CONTENT = #{roomContent},
			START_DT = TO_DATE(#{startDt},'YYYY-MM-DD HH24:MI:SS'),
			END_DT = TO_DATE(#{endDt},'YYYY-MM-DD HH24:MI:SS'),
			MDFR_ID = #{mdfrId},
			MDFCN_DT = SYSDATE
		WHERE
			RESERVE_SEQ = #{reserveSeq}
			AND ROOM_STATUS = 1
			AND DEL_YN != 'Y'
	</update>
	
	<update id="cancelReservation" parameterType="com.iyoons.world.vo.RoomVO">
		UPDATE
			ROOM_RESERVATION
		SET
			ROOM_STATUS = 0,
			MDFR_ID = #{mdfrId},
			MDFCN_DT = SYSDATE
		WHERE
			RESERVE_SEQ = #{reserveSeq}
			AND ROOM_STATUS = 1
			AND DEL_YN != 'Y'
	</update>
	
	
	
</mapper>