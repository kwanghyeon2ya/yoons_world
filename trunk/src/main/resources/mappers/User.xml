<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iyoons.world.dao.UserDAO">

	<select id="findUser" resultType="com.iyoons.world.vo.UserVO">
		select 
			user_id,
			user_seq,
			user_pw,
			user_name,
			user_type,
			user_status
		from
			user_info 
		where
			user_id=#{userId} 
			and user_pw=#{userPw}
	</select>
	<!-- 아이디 중복 확인 -->
	<select id="checkId" resultType="int">
		select 
			count(1)
		from 
			user_info
		where
			user_id=#{userId}
	</select>
	<select id="getCountUser" resultType="int">
		select 
			count(1)
		from 
			user_info
	</select>
	<select id="userList" resultType="com.iyoons.world.vo.UserVO">
		select
			cd.*
		from	
			(select
				user_id,
				user_name,
				user_type,
				user_status,
				user_seq,
				first_insert_dt,
				email,
				row_number() over(order by user_status desc,first_insert_dt asc) as r
			FROM
				user_info
			where
				1=1
			<if test="search == 'member_name'">
				and user_name like '%${keyword}%'
			</if>
			<if test="search == 'member_id'">
				and user_id like '%${keyword}%'
			</if>
				)cd
			where 
				cd.r &gt;=#{startRow} 
				and cd.r &lt;= #{endRow}
	</select>

	<select id="getSearchedUserCount" resultType="int">
		select
			count(1)	
		FROM
			user_info
		where
			1=1
		<if test="search == 'member_name'">
			and user_name like '%${keyword}%'
		</if>
		<if test="search == 'member_id'">
			and user_id like '%${keyword}%'
		</if>
	</select>

	<select id="viewUser" resultType="com.iyoons.world.vo.UserVO">
		SELECT
			US.user_id,
			US.user_name,
			US.user_type,
			US.user_status,
			US.email,
			US.hire_dt,
			DP.dep_name
		FROM
			user_info US
		LEFT JOIN 
			dep DP 
		ON 
			US.user_seq = DP.user_seq
	</select>

	<!-- 회원 등록 -->
	<insert id="insertUser"
		parameterType="com.iyoons.world.vo.UserVO">
		INSERT INTO user_info (
			user_seq,
			user_id,
			user_pw,
			user_name,
			email,
			hire_dt,
			user_type,
			user_status,
			regr_seq
		)
		VALUES (
			user_seq.nextval,
			#{userId},
			#{userPw},
			#{userName},
			#{email},
			#{hireDt},
			#{userType},
			1,
			#{regrSeq}
		)
	</insert>

	<!-- 회원 수정 -->
	<update id="updateUser"
		parameterType="com.iyoons.world.vo.UserVO">
		UPDATE
			user_info
		SET
			user_name = #{userName},
			user_pw = #{userPw},
			email = #{email}
		WhERE
			user_seq = #{userSeq} <!-- 일련번호로 수정 -->
	</update>
	
	<!-- 회원 상세 페이지 -->
	<select id="userDetail" resultType="com.iyoons.world.vo.UserVO">
		SELECT
			user_id,
			user_name,
			email,
			user_seq
		FROM
			user_info
		WhERE
			user_id = #{userId} <!-- 일련번호로 수정 -->
	</select>

	<!-- 회원 삭제 -->
	<update id="deleteUser">
		UPDATE
			user_info
		SET
			user_status = 0,
			last_update_dt = sysdate,
			updr_seq = #{updrSeq}
		WhERE
			user_status = 1
			and user_seq in
			<foreach item="userSeq" collection="userSeqArray" open="(" close=")" separator=",">
				#{userSeq} <!-- 일련번호로 수정 -->
			</foreach>
	</update>
	<!-- 회원 삭제 -->
	<update id="recoverUserStatus">
		UPDATE
			user_info
		SET
			user_status = 1,
			last_update_dt = sysdate,
			updr_seq = #{updrSeq}
		WhERE
			user_status = 0
			and user_seq IN
		<foreach item="userSeq" collection="userSeqArray" open="(" close=")" separator=",">
			#{userSeq} <!-- 일련번호로 수정 -->
		</foreach>
	</update>
	
	<insert id="insertAutoLoginInfo" parameterType="com.iyoons.world.vo.UserAutoLoginVO">
		 insert into user_auto_login(cookie_key,
									 user_seq,
									 user_ip,
									 user_browser,
									 cookie_status,
									 reg_dt,
									 expiry_dt
										)
							  values(#{cookieKey},
							  		 #{userSeq},
							  		 #{userIp},
							  		 #{userBrowser},
							  		 1,
							  		 sysdate,
							  		 (sysdate+30)
										)
	</insert>
	
	<select id="getCookieInfo" parameterType="String" resultType="com.iyoons.world.vo.UserAutoLoginVO">
		select
			ua.user_seq,
			ua.user_browser,
			ua.reg_dt,
			(select user_name from user_info ui where ua.user_seq = ui.user_seq) as user_name,
			(select user_type from user_info ui where ua.user_seq = ui.user_seq and user_type = 1) as admin_type,
			(select user_id from user_info ui where ua.user_seq = ui.user_seq) as user_id
		from
			user_auto_login ua
		where
			ua.cookie_key = #{cookieKey}
			and sysdate between	reg_dt and expiry_dt
			and cookie_status = 1	
	</select>
	
	<update id="deleteCookie">
		update 
			user_auto_login
		set
			cookie_status = 0
		where
			cookie_key = #{cookieKey}
	</update>
	<update id="deleteCookieWhenLogin" parameterType="com.iyoons.world.vo.UserAutoLoginVO">
		update
			user_auto_login
		set
			cookie_status = 0
		where 
			user_seq = #{userSeq}
			and user_browser = #{userBrowser}
	</update>

</mapper>